services:
  # Database
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: saleor
      POSTGRES_PASSWORD: saleor123
      POSTGRES_DB: saleor
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U saleor"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Cache
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Saleor API (Official)
  api:
    image: ghcr.io/saleor/saleor:3.21
    restart: unless-stopped
    depends_on:
      - postgres  # Changed: removed condition
      - redis     # Changed: removed condition
    environment:
      # Database configuration
      DATABASE_URL: postgres://saleor:saleor123@postgres:5432/saleor
      REDIS_URL: redis://redis:6379/0

    volumes:
      - media_data:/app/media
    
  #  ports:
  #    - "8000:8000"
    # REMOVED: healthcheck section

  # Saleor Dashboard (Official)
  dashboard:
    image: ghcr.io/saleor/saleor-dashboard:3.21
    restart: unless-stopped
    depends_on:
      - api  # Changed: removed condition

  # Your Custom React Storefront
  storefront:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_SALEOR_API_URL: https://api.buildbasehq.com/graphql/
        NEXT_PUBLIC_STOREFRONT_URL: https://buildbasehq.com
        NEXT_PUBLIC_DEFAULT_CHANNEL: gtech-laptops
    restart: unless-stopped
    depends_on:
      - api

volumes:
  postgres_data:
  media_data: